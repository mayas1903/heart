<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,viewport-fit=cover">
  <title>–û–≥–æ–Ω–µ—á–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {margin:0; padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); width:100%; height:100%; overflow:hidden;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(to bottom,#ffe4f0,#ffd1dc);
    }
    .container {max-width:430px; margin:0 auto; display:flex; flex-direction:column; gap:16px; padding:12px; height:100%; box-sizing:border-box;}
    .ducks {position:relative; flex:1;}
    .user-block, .friend-block {position:absolute; background:rgba(255,255,255,0.8); border-radius:14px; padding:10px; width:120px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.08); z-index:2;}
    .user-block {top:16px; left:16px;} .friend-block {bottom:16px; right:16px;}
    .block-content {display:flex; flex-direction:column; align-items:center;}
    .avatar {width:58px; height:58px; border-radius:50%; object-fit:cover; margin-bottom:6px;}
    .big-number {font-size:24px; font-weight:bold; color:#ff758c; margin-top:4px;}
    .user-duck, .friend-duck {position:absolute; height:210px; z-index:1;}
    .user-duck {top:0; right:0;} .friend-duck {bottom:0; left:0;}
    .btn {width:70%; align-self:center; padding:14px; font-size:16px; font-weight:bold; color:#fff; border:none;
      background:linear-gradient(90deg,#ff758c,#ff7eb3); border-radius:28px; box-shadow:0 4px 10px rgba(255,117,140,0.3);
    }
    .progress-bar {width:100%; height:8px; background:rgba(255,255,255,0.5); border-radius:4px; overflow:hidden;}
    .progress-fill {height:100%; width:0; transition:width .3s ease; background:linear-gradient(90deg,#ff758c,#ff7eb3);}
    .progress-text {text-align:center; font-size:14px; color:#555; margin-bottom:4px;}
    .history {flex:1; overflow-y:auto; margin-bottom:60px;}
    .history-item {display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.8); border-radius:14px; padding:10px; margin-bottom:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
    .history-item span {font-size:14px; color:#333;}
    .history-item img {width:24px; height:24px;}
    .duck-animation {position:absolute; font-size:32px; animation:fly 1.8s ease-out forwards; pointer-events:none; z-index:1000;}
    @keyframes fly {0%{opacity:1;transform:translate(0,0)rotate(0deg);}100%{opacity:0;transform:translate(var(--x),var(--y))rotate(180deg);}}
  </style>
</head>
<body>
  <div class="container">
    <div class="ducks">
      <div class="user-block">
        <div class="block-content">
          <img id="myAvatar" class="avatar" alt="–ú–æ–π –∞–≤–∞—Ç–∞—Ä" src="avatar-placeholder.png">
          <h3 id="myName"></h3>
          <p class="big-number" id="myCount">0 üî•</p>
        </div>
      </div>
      <div class="friend-block">
        <div class="block-content">
          <img id="friendAvatar" class="avatar" alt="–ê–≤–∞—Ç–∞—Ä –¥—Ä—É–≥–∞" src="avatar-placeholder.png">
          <h3 id="friendName">–î—Ä—É–≥</h3>
          <p class="big-number" id="friendCount">0 üî•</p>
        </div>
      </div>
      <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ GIF -->
      <img id="userDuck" class="user-duck" alt="–û–≥–æ–Ω–µ—á–µ–∫ —è" src="mygif.gif">
      <img id="friendDuck" class="friend-duck" alt="–û–≥–æ–Ω–µ—á–µ–∫ –¥—Ä—É–≥" src="friendgif.gif">
    </div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    <div class="progress-text" id="progressText">0 –∏–∑ 0</div>
    <button class="btn" id="loveBtn">‚ù§Ô∏è –°–∫—É—á–∞—é –ø–æ —Ç–µ–±–µ</button>
    <div class="history" id="history"></div>
  </div>
  <script>
    // WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    const socket = new WebSocket('wss://serverheart.onrender.com');
    let role = null;
    socket.onopen = () => socket.send(JSON.stringify({ type: 'join' }));
    socket.onmessage = ({ data }) => {
      const msg = JSON.parse(data);
      if (msg.type === 'join') {
        role = msg.role;
        update(msg.state);
      } else if (msg.type === 'update') {
        update(msg.payload);
      } else if (msg.type === 'resetDone') {
        update({ scores: { userA: 0, userB: 0 }, history: [] });
        alert('–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω—É–ª—ë–Ω');
      }
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const el = id => document.getElementById(id);
    const countEl = el('myCount'), friendCountEl = el('friendCount'), fillEl = el('progressFill'), textEl = el('progressText'), histEl = el('history');

    function update(state) {
      const meCount = role === 'userA' ? state.scores.userA : state.scores.userB;
      const frCount = role === 'userA' ? state.scores.userB : state.scores.userA;
      const total = state.scores.userA + state.scores.userB;
      countEl.textContent = `${meCount} üî•`;
      friendCountEl.textContent = `${frCount} üî•`;
      const max = Math.min((Math.floor(total/1000)+1)*1000, 10000);
      fillEl.style.width = `${(total/max)*100}%`;
      textEl.textContent = `${total} –∏–∑ ${max}`;
      renderHistory(state.history || []);
    }

    function renderHistory(arr) {
      histEl.innerHTML = '';
      arr.forEach(({ actor, time }) => {
        const div = document.createElement('div'); div.className = 'history-item';
        const img = document.createElement('img');
        img.src = actor === 'userA' ? 'mygif.gif' : 'friendgif.gif';
        const span = document.createElement('span'); span.textContent = `${time} ${actor}`;
        div.append(img, span);
        histEl.append(div);
      });
    }

    function flyEmoji() {
      const btn = el('loveBtn');
      const r = btn.getBoundingClientRect();
      const d = document.createElement('div'); d.className = 'duck-animation'; d.textContent = 'üî•';
      d.style.left = `${r.left + r.width/2 - 16}px`;
      d.style.top = `${r.top + r.height/2 - 16}px`;
      document.body.append(d);
      const x = (Math.random()*200 - 100).toFixed() + 'px';
      const y = (-Math.random()*200 - 50).toFixed() + 'px';
      d.style.setProperty('--x', x);
      d.style.setProperty('--y', y);
      d.onanimationend = () => d.remove();
    }

    el('loveBtn').onclick = () => {
      socket.send(JSON.stringify({ type: 'click', role }));
      flyEmoji();
    };
  </script>
</body>
</html>

